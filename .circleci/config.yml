version: 2
jobs:
  build:
    docker:
      - image: circleci/python:3.6.8

    working_directory: ~/cimr-d

    steps:
      - checkout

      - run:
          name: Install git-lfs
          command: |
            curl -s https://packagecloud.io/install/repositories/github/git-lfs/script.deb.sh | bash
            apt-get update
            apt-get install -y git-lfs openssh-client
            git lfs install
            mkdir -p ~/.ssh
            ssh-keyscan -H github.com >> ~/.ssh/known_hosts
            ssh git@github.com git-lfs-authenticate "${CIRCLE_PROJECT_USERNAME}/${CIRCLE_PROJECT_REPONAME}" download
      
      - run:
          name: Install cimr + dependencies
          command: |
            .travis/install_cimr.sh
      
      - run:
          name: Process new PR
          command: | 
            python3 .travis/process_submitted_data.py
            
      - run:
          name: Push processed data
          command: |
            .travis/push_processed_data.sh

